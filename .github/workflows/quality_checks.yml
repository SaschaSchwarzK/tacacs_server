name: Quality Checks (Lint • Tests • Advanced Tests • CodeQL)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: "0 3 * * 1"  # weekly Monday 03:00 UTC (for CodeQL / deep scans)
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  setup:
    name: Setup Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      cache-hit: ${{ steps.setup.outputs.cache-hit }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python and Poetry
        id: setup
        uses: ./.github/actions/setup-python-poetry

  quality:
    name: Lint (Ruff • Mypy • Bandit)
    runs-on: ubuntu-latest
    needs: [setup]
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-python-poetry

      - name: Cache Poetry and venv
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pypoetry
            ~/.cache/pip
            .venv
          key: poetry-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}-${{ steps.setup-python.outputs.python-version || 'py' }}
          restore-keys: |
            poetry-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}-
            poetry-${{ runner.os }}-

      - name: Ensure dev/runtime dependencies installed
        run: |
          poetry install --with dev

      - name: Ensure dev dependencies installed
        run: |
          poetry install --with dev

      - name: Ruff (lint)
        run: |
          poetry run ruff check .

      - name: Ruff (format check)
        run: |
          poetry run ruff format --check .

      - name: Mypy (type check)
        run: |
          echo "Running mypy file by file to reduce output noise..."
          find tacacs_server -name "*.py" -type f | while read -r file; do
            echo "Checking $file..."
            poetry run mypy "$file" || echo "Issues found in $file"
          done

      - name: Bandit (security lint)
        run: |
          # Use project .bandit config to exclude tests and venv/site-packages
          poetry run bandit -r . --configfile .bandit

      - name: pip-audit (vuln scan)
        run: |
          pip install pip-audit
          pip-audit -r <(poetry export -f requirements.txt --without-hashes) || true

      - name: Semgrep (CI rules)
        uses: semgrep/semgrep-action@v1
        with:
          config: "p/ci"

  tests:
    name: Tests • Coverage
    runs-on: ubuntu-latest
    needs: [setup, quality]
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-python-poetry

      - name: Cache Poetry and venv
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pypoetry
            ~/.cache/pip
            .venv
          key: poetry-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}-${{ steps.setup-python.outputs.python-version || 'py' }}
          restore-keys: |
            poetry-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}-
            poetry-${{ runner.os }}-

      - name: Ensure dev dependencies installed
        run: |
          poetry config virtualenvs.in-project true
          poetry install --with dev

      - name: Prepare log dir for server
        run: |
          mkdir -p $RUNNER_TEMP/tacacs_logs
          echo "TACACS_TEST_LOG=$RUNNER_TEMP/tacacs_logs" >> $GITHUB_ENV

      - name: Pytest (XML & coverage)
        run: |
          poetry run pytest -q \
            --ignore=tests/chaos \
            --ignore=tests/security \
            --ignore=tests/contract \
            --ignore=tests/e2e \
            --junitxml=test-results/junit.xml \
            --cov=. --cov-report=xml:coverage.xml --cov-report=term-missing \
            --cov-fail-under=0

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-artifacts
          path: |
            test-results/junit.xml
            coverage.xml
            ${{ runner.temp }}/tacacs_logs/**
          exclude: |
            **/*.env
            **/*.key
            **/*.pem
            **/*secret*
            **/*password*
            **/*token*
            **/*credential*

  docker-smoke:
    name: Docker Build • Smoke Test
    runs-on: ubuntu-latest
    needs: [setup, quality, tests]
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - name: Build image
        run: |
          docker build -t tacacs:ci .
      - name: Run container
        run: |
          docker run -d --rm --name tacacs-ci -p 8080:8080 tacacs:ci
          # Wait for readiness
          for i in {1..30}; do
            curl -fsS http://127.0.0.1:8080/health && break || sleep 1;
          done
          curl -fsS http://127.0.0.1:8080/ready
      - name: Logs on failure
        if: failure()
        run: |
          docker logs tacacs-ci || true
      - name: Stop container
        if: always()
        run: |
          docker rm -f tacacs-ci || true

  # chaos-tests:
  #   name: Chaos Engineering Tests
  #   runs-on: ubuntu-latest
  #   needs: [setup, tests]
  #   timeout-minutes: 10
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: ./.github/actions/setup-python-poetry

  #     - name: Run Chaos Tests
  #       run: |
  #         poetry run python scripts/run_advanced_tests.py --test-type chaos

  # security-tests:
  #   name: Security Penetration Tests
  #   runs-on: ubuntu-latest
  #   needs: [setup, tests]
  #   timeout-minutes: 10
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: ./.github/actions/setup-python-poetry

  #     - name: Run Security Tests
  #       run: |
  #         poetry run python scripts/run_advanced_tests.py --test-type security

  # contract-tests:
  #   name: API Contract Tests
  #   runs-on: ubuntu-latest
  #   needs: [setup, tests]
  #   timeout-minutes: 5
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: ./.github/actions/setup-python-poetry

  #     - name: Run Contract Tests
  #       run: |
  #         poetry run python scripts/run_advanced_tests.py --test-type contract

  # e2e-tests:
  #   name: End-to-End Integration Tests
  #   runs-on: ubuntu-latest
  #   needs: [setup, tests]
  #   timeout-minutes: 10
  #   env:
  #     PYTHONPATH: ${{ github.workspace }}
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: ./.github/actions/setup-python-poetry
  #     - name: Poetry install (with dev)
  #       run: poetry install --with dev
  #     - name: Export app env
  #       run: |
  #         {
  #           echo "APP_HOST=127.0.0.1"
  #           echo "APP_PORT=8000"
  #           echo "ENV=ci"
  #         } >> $GITHUB_ENV

  #     - name: Run E2E Tests
  #       run: |
  #         export PYTEST_ADDOPTS="--log-cli-level=INFO -vv -s"
  #         poetry run python scripts/run_advanced_tests.py --test-type e2e
      
      

  #     - name: Upload advanced test artifacts
  #       uses: actions/upload-artifact@v4
  #       if: always()
  #       with:
  #         name: advanced-test-artifacts
  #         path: |
  #           test-results/
  #           logs/
  #         exclude: |
  #           **/*.env
  #           **/*.key
  #           **/*.pem
  #           **/*secret*
  #           **/*password*
  #           **/*token*
  #           **/*credential*

  # advanced-tests-summary:
  #   name: Advanced Tests Summary
  #   runs-on: ubuntu-latest
  #   needs: [chaos-tests, security-tests, contract-tests, e2e-tests]
  #   if: always()
  #   steps:
  #     - name: Check Advanced Tests Results
  #       run: |
  #         echo "Advanced Tests Summary:"
  #         echo "- Chaos Tests: ${{ needs.chaos-tests.result }}"
  #         echo "- Security Tests: ${{ needs.security-tests.result }}"
  #         echo "- Contract Tests: ${{ needs.contract-tests.result }}"
  #         echo "- E2E Tests: ${{ needs.e2e-tests.result }}"
          
  #         if [[ "${{ needs.chaos-tests.result }}" == "success" && \
  #               "${{ needs.security-tests.result }}" == "success" && \
  #               "${{ needs.contract-tests.result }}" == "success" && \
  #               "${{ needs.e2e-tests.result }}" == "success" ]]; then
  #           echo "✅ All advanced tests passed!"
  #         else
  #           echo "⚠️ Some advanced tests failed or were skipped"
  #           exit 1
  #         fi

  codeql:
    name: CodeQL (Python)
    runs-on: ubuntu-latest
    needs: [setup]
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python
      - uses: ./.github/actions/setup-python-poetry

      - name: Analyze
        uses: github/codeql-action/analyze@v3

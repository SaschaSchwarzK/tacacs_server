version: "3.9"

services:
  tacacs:
    build: .
    image: tacacs-server:dev
    container_name: tacacs-server
    env_file:
      - .env
    ports:
      - "8080:8080"   # Web admin/API
      - "5049:5049"   # TACACS+ (dev profile)
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://127.0.0.1:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    networks:
      - observability

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
    networks:
      - observability
    depends_on:
      - tacacs

  loadgen:
    image: tacacs-server:dev
    container_name: tacacs-loadgen
    depends_on:
      - tacacs
    # Mount repo to access scripts/generate_load.py in the container
    volumes:
      - ./:/app:ro
    entrypoint: ["tini","--"]
    command:
      [
        "python",
        "scripts/generate_load.py",
        "--host","tacacs",
        "--port","5049",
        "--users","apitestuser:ApiTestPass1!",
        "--duration","60",
        "--concurrency","8",
        "--mix","auth,author,acct"
      ]
    networks:
      - observability

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_FEATURE_TOGGLES_ENABLE=publicDashboards
      - GF_PUBLIC_DASHBOARDS_ENABLED=true
    volumes:
      - ./docker/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      - ./docker/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./docker/grafana/dashboards:/var/lib/grafana/dashboards:ro
    networks:
      - observability
    depends_on:
      - prometheus

networks:
  observability:
    driver: bridge

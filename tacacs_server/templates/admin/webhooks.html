{% extends "admin/base.html" %}
{% block content %}
<div class="card">
  <h2 style="margin-top:0">Webhook & Threshold Configuration</h2>
  <form onsubmit="saveConfig(event)">
    <div class="modal-field">
      <label>Webhook URLs (one per line or comma-separated)</label>
      <textarea id="urls" rows="4">{{ '\n'.join(config['urls']) }}</textarea>
      <div class="modal-hint">Leave empty to disable webhooks</div>
    </div>
    <div class="modal-field">
      <label>Headers (JSON)</label>
      <textarea id="headers" rows="4">{{ config['headers'] | tojson(indent=2) }}</textarea>
      <div class="modal-hint">Example: {"Authorization":"Bearer &lt;token&gt;"}</div>
    </div>
    <div class="modal-field">
      <label>
        Template (JSON with {{'{{placeholder}}'}})
        <span title="Available placeholders: event, username, client_ip, detail, key, count, window_sec. Values depend on event type (e.g., auth_failure, threshold_exceeded)." style="cursor:help;color:#6b7280; margin-left:6px">&#9432;</span>
      </label>
      <textarea id="template" rows="6">{{ config['template'] | tojson(indent=2) }}</textarea>
      <div class="modal-hint">Example for auth_failure event:</div>
      <pre style="background:#f9fafb;border:1px solid #e5e7eb;border-radius:6px;padding:10px;margin:0">
{
  "event": "{{'{{event}}'}}",
  "username": "{{'{{username}}'}}",
  "client_ip": "{{'{{client_ip}}'}}",
  "detail": "{{'{{detail}}'}}"
}
      </pre>
      <div class="modal-hint" style="margin-top:8px">Example for threshold_exceeded event:</div>
      <pre style="background:#f9fafb;border:1px solid #e5e7eb;border-radius:6px;padding:10px;margin:0">
{
  "event": "{{'{{event}}'}}",
  "key": "{{'{{key}}'}}",
  "count": "{{'{{count}}'}}",
  "window_sec": "{{'{{window_sec}}'}}"
}
      </pre>
    </div>
    <div class="modal-field">
      <label>Timeout (seconds)</label>
      <input id="timeout" type="number" step="0.1" value="{{ config['timeout'] }}" />
    </div>
    <div class="modal-field">
      <label>Failure Threshold Count</label>
      <input id="threshold_count" type="number" value="{{ config['threshold_count'] }}" />
      <div class="modal-hint">Set &gt; 0 to enable aggregation</div>
    </div>
    <div class="modal-field">
      <label>Threshold Window (seconds)</label>
      <input id="threshold_window" type="number" value="{{ config['threshold_window'] }}" />
    </div>
    <div class="modal-actions">
      <button class="btn" type="submit">Save</button>
    </div>
  </form>

  <h3>Current Config</h3>
  <pre id="result">{{ config | tojson(indent=2) }}</pre>
</div>

<script>
async function saveConfig(ev){
  ev.preventDefault();
  const urls = document.getElementById('urls').value.split(/\n|,/).map(s=>s.trim()).filter(Boolean);
  let headers={}; let template={};
  try { headers = JSON.parse(document.getElementById('headers').value||'{}'); } catch(e) { alert('Invalid headers JSON'); return; }
  try { template = JSON.parse(document.getElementById('template').value||'{}'); } catch(e) { alert('Invalid template JSON'); return; }
  const timeout = parseFloat(document.getElementById('timeout').value||'3');
  const threshold_count = parseInt(document.getElementById('threshold_count').value||'0');
  const threshold_window = parseInt(document.getElementById('threshold_window').value||'60');
  const resp = await fetch('/admin/webhooks-config', { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({urls, headers, template, timeout, threshold_count, threshold_window})});
  if(!resp.ok){ const t=await resp.text(); alert('Failed to save: '+t); return; }
  const cfg = await resp.json();
  document.getElementById('result').textContent = JSON.stringify(cfg, null, 2);
  alert('Saved');
}
</script>
{% endblock %}

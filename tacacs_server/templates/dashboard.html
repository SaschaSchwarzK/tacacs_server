<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>TACACS+ Server Monitor</title>
    <link rel="stylesheet" href="/static/css/dashboard.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* fallback styles if CSS not loaded */
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
    </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>TACACS+ Server Monitor</h1>
      <p>Server Status: <strong>{{ stats.status|upper }}</strong></p>
      <button onclick="location.reload()">Refresh</button>
    </div>

    {% if api_disabled %}
    <div style="background:#fff3cd;color:#664d03;border:1px solid #ffecb5;padding:10px;border-radius:6px;margin:10px 0;">
      <strong>API disabled:</strong> No API token configured. Set <code>API_TOKEN</code> to enable the REST API. The admin UI remains functional.
    </div>
    {% endif %}

    <div>
      <p>Uptime: {{ (stats.uptime // 3600) }}h {{ ((stats.uptime % 3600) // 60) }}m</p>
      <p>Active connections: {{ stats.connections.active }}</p>
      <p>Proxied: {{ stats.connections.proxied }} | Direct: {{ stats.connections.direct }} | Proxy Rejected: {{ stats.connections.proxied_rejected_unknown or 0 }}</p>
      <p>Auth success rate: {{ stats.authentication.success_rate }}%</p>
    </div>

    <div style="max-width:600px; margin-top:20px;">
      <canvas id="authChart" width="600" height="300"></canvas>
    </div>

    <h3>Backends</h3>
    <ul id="backendList"></ul>
  </div>

  <script>
    // build simple doughnut from server rendered values
    const ctx = document.getElementById('authChart').getContext('2d');
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Success','Failed'],
        datasets: [{
          data: [{{ stats.authentication.successes }}, {{ stats.authentication.failures }}],
          backgroundColor: ['#28a745','#dc3545']
        }]
      },
      options: { responsive: true }
    });

    // fetch backends (may fail if API disabled)
    fetch('/api/backends').then(r => r.json()).then(backends => {
      const list = document.getElementById('backendList');
      backends.forEach(b => {
        const li = document.createElement('li');
        li.textContent = `${b.name} (${b.type}) - ${b.available ? 'Available' : 'Unavailable'}`;
        list.appendChild(li);
      });
    }).catch(()=>{
      const list = document.getElementById('backendList');
      const li = document.createElement('li');
      li.textContent = 'Backends unavailable (API disabled or unreachable).';
      list.appendChild(li);
    });
  </script>
</body>
</html>
